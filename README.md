# LevelST: Stream-based Accelerator for Sparse Triangular Solver with HBM-FPGA

[![DOI](https://zenodo.org/badge/599503718.svg)](https://zenodo.org/doi/10.5281/zenodo.10278197)

LevelST is a HBM-FPGA based stream accelerator for sparse triangular solver. It is designed and tested on Xilinx Alveo U280 FPGA board.

**Dependencies:**

- TAPA & Autobridge (follow [this](https://tapa.readthedocs.io/en/release/installation.html) instruction to install TAPA and other dependencies)
- Vitis 2021.2, Vivado 2021.2
- Xilinx `xilinx_u280_xdma_201920_3` platform shell (more recent platform requires modification on Autobridge source file)

**Input matrix format:**

The host code takes [Matrix Market](https://math.nist.gov/MatrixMarket/formats.html) format. We test on triangular matrices decomposed from sparse matrices in [SuiteSparse](https://sparse.tamu.edu) collection. 

## Build Host and Software Simulation

Compile the host code

```bash
make
```
This will run `g++` to compile the host code for you.

**Notice:** The Makefile is written to execute on a server with package manager like `spack` in order to link the include files and library binary. You are free to change `-I` flags and `-L` flags depending on your system setup. Also, remember to set the environment variables `LD_LIBRARY_PATH` and `CPATH` in `.bashrc`

Finally, execute the software simulation
```
./trig-solver
```
The default matrix is `lp1.mtx` provided in this repository. To test other matrices, simply pass an argument by
```
./trig-solver --file <matrix_file.mtx>
```

## Run TAPA & Autobridge for HLS and Floorplanning Optimization

```
bash run_tapa.sh
```

This will generate a folder containing multiple subfolders, where each contains:

- a TCL file for floorplanning constraint
- A bash script to run bitstream generation
- Autobridge log
- HLS code of each module compiled by TAPA
- RTL code
- HLS logs and reports

A rough estimation of area usage is in the Autobridge log. Each subfolder represents a solution generated by Autobridge

## Hardware Emulation (cosim)

Modify the bash script `solver.xilinx_u280_xdma_201920_3.hw.xo.tapa/run-n/solver.xilinx_u280_xdma_201920_3.hw_generate_bitstream.sh` by uncomment the second `TARGET` variable and `DEBUG` variable.

```bash
#!/bin/bash
# TARGET=hw
TARGET=hw_emu
DEBUG=-g
```

Run the bitstream generation for hardware emulation

```
bash solver.xilinx_u280_xdma_201920_3.hw_generate_bitstream.sh
```
You will get a xclbin file under `vitis_run_hw_emu` folder. Run the emulation by

```
./trig-solver --bitstream path/to/the/xclbin/file
```

## Run on FPGA hardware
Use the same bash script without uncommenting. Run the bitstream generation for FPGA fabric. There will be an xclbin file under `vitis_run_hw` folder. Run the hardware by
```
./trig-solver --bitstream path/to/the/xclbin/file
```

We have already generated the bitstream for you under `bitstream` folder. So you can simple run
```
./trig-solver --bitstream bitstream/TrigSolver_xilinx_u280_xdma_201920_3_fwd.xclbin
```

Other useful report includes

- `TrigSolver_xilinx_u280_xdma_201920_3_fwd.xclbin.info`: information about clock speed and HBM/DDR usage
- `solver_final.tcl`: the floorplanning constraint we used

Power consumption and on-chip resource utilization are in the `vitis_run_hw` folder.
